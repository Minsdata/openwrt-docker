name: Manifest_Dockerhub_Push
#normal mode
#on:
#  schedule:
#    - cron: "0 0 */1 * *"
#test mode
on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Image tag'
        required: true
        default: 'test the action'
jobs:
  manifest-tool:
    runs-on: ubuntu-latest
    steps:      
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Set Date variables for openwrt
        run: |
          echo "TODAYS_DATE=$(date +'%Y.%m.%d')" >> $GITHUB_ENV

      - name: Enable experimental mode
        run: |
          echo 'export DOCKER_CLI_EXPERIMENTAL=enabled' >> $GITHUB_ENV

      - name: Pull Docker image
        run: |
          docker pull minsdatadocker/openwrt:x86
          docker pull --platform linux/arm64 minsdatadocker/openwrt:arm64
  
      - name: Push Images to DockerHub as Multi Platform Image with Ver Tag
        run: |          
          docker manifest create --insecure minsdatadocker/openwrt:${{ env.TODAYS_DATE }} minsdatadocker/openwrt:x86 minsdatadocker/openwrt:arm64
          docker manifest annotate minsdatadocker/openwrt:${{ env.TODAYS_DATE }} minsdatadocker/openwrt:x86 --os linux --arch amd64 
          docker manifest annotate minsdatadocker/openwrt:${{ env.TODAYS_DATE }} minsdatadocker/openwrt:arm64 --os linux --arch arm64
          docker manifest push --insecure minsdatadocker/openwrt:${{ env.TODAYS_DATE }}

      - name: Push Images to DockerHub as Multi Platform Image with Latest Tag
        run: |          
          docker manifest create --insecure minsdatadocker/openwrt:latest minsdatadocker/openwrt:x86 minsdatadocker/openwrt:arm64
          docker manifest annotate minsdatadocker/openwrt:latest minsdatadocker/openwrt:x86 --os linux --arch amd64 
          docker manifest annotate minsdatadocker/openwrt:latest minsdatadocker/openwrt:arm64 --os linux --arch arm64
          docker manifest push --insecure minsdatadocker/openwrt:latest

          
